<?xml version="1.0" encoding="UTF-8"?>
<refentry id="cnid_dbd.8">
  <refmeta>
    <refentrytitle>cnid_dbd</refentrytitle>

    <manvolnum>8</manvolnum>

    <refmiscinfo class="date">01 Jan 2012</refmiscinfo>

    <refmiscinfo class="source">@NETATALK_VERSION@</refmiscinfo>
  </refmeta>

  <refnamediv>
    <refname>cnid_dbd</refname>

    <refpurpose>専用デーモンプロセスを通してCNIDデータベースへのアクセスを実装する</refpurpose>
  </refnamediv>

  <refsynopsisdiv>
    <cmdsynopsis>
      <command>cnid_dbd<indexterm>
          <primary>cnid_dbd</primary>
        </indexterm><indexterm>
          <primary>CNID backend</primary>
        </indexterm><indexterm>
          <primary>NFS</primary>

          <secondary>Network File System</secondary>
        </indexterm></command>

      <sbr />

      <command>cnid_dbd<indexterm>
          <primary>cnid_dbd</primary>
        </indexterm></command>

        <group choice="plain">
          <arg choice="plain">-v</arg>
          <arg choice="plain">-V</arg>
        </group>
    </cmdsynopsis>
  </refsynopsisdiv>

  <refsect1>
    <title>説明</title>

    <para><command>cnid_dbd</command>はストレージとカタログノードID (CNID)と関連情報の検索のためのインターフェースを<emphasis remap="B">afpd</emphasis>デーモンに提供する。CNIDはMacintoshベースのファイルシステムの構成要素であるが、これの動作は単純にはUnixファイルシステム上にマッピングできない。従って、一つのデータベース内に分離した記憶域が必要となる。<command>cnid_dbd</command>は<emphasis remap="B">afpd</emphasis>の<emphasis remap="B">CNIDバックエンド</emphasis>の一つであり、<emphasis remap="B">dbd</emphasis>バックエンドを実装する。</para>

    <para><command>cnid_dbd</command>はコマンドラインやシステム起動スクリプトではなく、<emphasis remap="B">cnid_metad</emphasis>デーモンによって起動する。netatalkボリューム一つにつき、<command>cnid_dbd</command>のインスタンスが一つである。</para>

    <para><command>cnid_dbd</command>は<emphasis remap="B">Berkeley DB</emphasis>データベースライブラリを用いて、トランザクションで保護したアップデートを行う。トランザクションによる<emphasis remap="B">dbd</emphasis>バックエンドは、たとえシステムが不意にクラッシュしても、CNIDデータベースの破損を防ぐだろう。</para>

    <para><command>cnid_dbd</command>は起動時に<emphasis remap="B">cnid_metad</emphasis>からの有効なユーザIDとグループIDを継承する。普通、この動作はnetatalkボリュームをクライアントへ提供する<emphasis remap="B">afpd</emphasis>によって生じる。それはボリュームに関連付けられた<emphasis remap="B">Berkeley DB</emphasis>データベースのホームディレクトリ<emphasis remap="I">dbdir</emphasis>を変更する。もし<emphasis remap="B">cnid_metad</emphasis>から継承したユーザIDが0 (root)ならば、<command>cnid_dbd</command>はユーザIDとグループIDをデータベースホームディレクトリの所有者とグループに変更する。そうでない場合は、継承した値を使い続ける。このとき、<command>cnid_dbd</command>はデータベースを開き、ファイル記述子<emphasis remap="I">clntfd</emphasis>を使って要求されたものを提供開始する。同じボリュームへアクセスしようとする次の<emphasis remap="B">afpd</emphasis>のインスタンスは、ファイル記述子<emphasis remap="I">ctrlfd</emphasis>を用いる<emphasis remap="B">cnid_metad</emphasis>によって、既に動いている<command>cnid_dbd</command>へリダイレクトされる。</para>

    <para><command>cnid_dbd</command>は、永久に動作するか、または不活性期間の後に終了するかを設定できる。もし<command>cnid_dbd</command>がTERMやINTシグナルを受け取った場合、汚れたデータベースバッファをディスクにフラッシュし、<emphasis remap="B">Berkeley DB</emphasis>データベース環境を閉じてから、綺麗に終了する。この方法で<command>cnid_dbd</command>を終了するのは安全な事であり、もし必要なら再起動する。他のシグナルは処理されず、即座に終了するか、もしかすると(トランザクションなしのとき)CNIDデータベースを矛盾した状態のままにしておくか、(トランザクションありのとき)リカバリ中の直近の更新を失うかするだろう。</para>

    <para><emphasis remap="B">Berkeley DB</emphasis>データベースサブシステムは、データベースのホームディレクトリ<emphasis remap="I">dbdir</emphasis>にlog.xxxxxxxxxxという名前のファイルを作る。ここでxxxxxxxxxxは、単調増加する整数である。これらのファイルにはトランザクションにおけるデータベースの変更が記載されている。これらのファイルは、<emphasis remap="I">db_param</emphasis>設定ファイル(以下を見よ)で<emphasis remap="B">logfile_autoremove</emphasis>の値が0 (デフォルトは1)に設定されている場合を除いて、定期的に削除される。</para>
  </refsect1>

  <refsect1>
    <title>オプション</title>

    <variablelist remap="TP">
      <varlistentry>
        <term><option>-v, -V</option></term>
	
        <listitem>
          <para>バージョンを表示してから終了する。</para>
        </listitem>
      </varlistentry>
    </variablelist>
  </refsect1>

  <refsect1>
    <title>設定</title>

    <para><command>cnid_dbd</command>は起動時、データベースディレクトリ<emphasis remap="I">dbdir</emphasis> の中のファイル<emphasis remap="I">db_param</emphasis>から設定情報を読む。ファイルがない場合やパラメータが載っていない場合、適切なデフォルト値が使われる。ひとつのパラメータのフォーマットは、まずパラメータ名、それに続く一つ以上のスペース、それに続くパラメータ値、それに続く改行で構成される。現在以下のパラメータが認識される:</para>

    <variablelist remap="TP">
      <varlistentry>
        <term><emphasis remap="B">logfile_autoremove</emphasis></term>

        <listitem>
          <para>もし0を設定した場合、<command>cnid_dbd</command>の起動時に未使用のBerkeley DBトランザクションのログファイル(データベースホームディレクトリの中のlog.xxxxxxxxxx)の定期的な削除が行われない。デフォルトは1。</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><emphasis remap="B">cachesize</emphasis></term>

        <listitem>
          <para>Berkeley DBのキャッシュサイズをキロバイト単位で決定する。デフォルトは8192。それぞれの<command>cnid_dbd</command>プロセスは通常のメモリ占有量に加えて大量のメモリを獲得する。これはデータベースのパフォーマンスを調整するのに使われる。Berkley DBに附属する<emphasis remap="B">db_stat</emphasis>ユーティリティに<option>-m</option>オプションを付けると、この値を変更すべきかどうかを決定するのに役立つ。デフォルトではキャッシュが要求の大半を丁度良く満たすように極めて保守的な値になっている。メモリがシステムのボトルネックにならないなら、あなたはその値を放置してよい。<emphasis remap="B">Berkeley DB Tutorial and Reference Guide</emphasis>には、より詳しい情報を記した<emphasis remap="B">Selecting a cache size</emphasis>という章がある。</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><emphasis remap="B">flush_frequency</emphasis></term>

        <term><emphasis remap="B">flush_interval</emphasis></term>

        <listitem>
          <para><emphasis remap="I">flush_frequency</emphasis> (Default: 1000)
          and <emphasis remap="I">flush_interval</emphasis> (Default: 1800)
          control how often changes to the database are checkpointed. Both of
          these operations are performed if either i) more than <emphasis
          remap="I">flush_frequency</emphasis> requests have been received or
          ii) more than <emphasis remap="I">flush_interval</emphasis> seconds
          have elapsed since the last save/checkpoint. Be careful to check
          your harddisk configuration for on disk cache settings. Many IDE
          disks just cache writes as the default behaviour, so even flushing
          database files to disk will not have the desired effect.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><emphasis remap="B">fd_table_size</emphasis></term>

        <listitem>
          <para>is the maximum number of connections (filedescriptors) that
          can be open for <emphasis remap="B">afpd</emphasis> client processes
          in <emphasis remap="B">cnid_dbd.</emphasis> Default: 512. If this
          number is exceeded, one of the existing connections is closed and
          reused. The affected <emphasis remap="B">afpd</emphasis> process
          will transparently reconnect later, which causes slight overhead. On
          the other hand, setting this parameter too high could affect
          performance in <command>cnid_dbd</command> since all descriptors
          have to be checked in a <function>select()</function> system call,
          or worse, you might exceed the per process limit of open file
          descriptors on your system. It is safe to set the value to 1 on
          volumes where only one <emphasis remap="B">afpd</emphasis> client
          process is expected to run, e.g. home directories.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><emphasis remap="B">idle_timeout</emphasis></term>

        <listitem>
          <para>is the number of seconds of inactivity before an idle
          <command>cnid_dbd</command> exits. Default: 600. Set this to 0 to
          disable the timeout.</para>
        </listitem>
      </varlistentry>
    </variablelist>
  </refsect1>

  <refsect1>
    <title>UPDATING</title>

    <para>Note that the first version to appear <emphasis>after</emphasis>
    Netatalk 2.1 ie Netatalk 2.1.1, will support BerkeleyDB updates on the fly
    without manual intervention. In other words Netatalk 2.1 does contain code
    to prepare the BerkeleyDB database for upgrades and to upgrade it in case
    it has been prepared before. That means it can't upgrade a 2.0.x version
    because that one didn't prepare the database.</para>

    <para>In order to update between older Netatalk releases using different
    BerkeleyDB library versions, follow this steps:</para>

    <itemizedlist>
      <listitem>
        <para>Stop the to be upgraded old version of Netatalk</para>
      </listitem>

      <listitem>
        <para>Using the old BerkeleyDB utilities run <command>db_recover -h
        &lt;path to .AppleDB&gt;</command></para>
      </listitem>

      <listitem>
        <para>Using the new BerkeleyDB utilities run <command>db_upgrade -v -h
        &lt;path to .AppleDB&gt; -f cnid2.db</command></para>
      </listitem>

      <listitem>
        <para>Again using the new BerkeleyDB utilities run
        <command>db_checkpoint -1 -h &lt;path to .AppleDB&gt;</command></para>
      </listitem>

      <listitem>
        <para>Start the the new version of Netatalk</para>
      </listitem>
    </itemizedlist>

  </refsect1>

  <refsect1>
    <title>SEE ALSO</title>

    <para><citerefentry>
        <refentrytitle>cnid_metad</refentrytitle>

        <manvolnum>8</manvolnum>
      </citerefentry>, <citerefentry>
        <refentrytitle>afpd</refentrytitle>

        <manvolnum>8</manvolnum>
      </citerefentry>, <citerefentry>
        <refentrytitle>dbd</refentrytitle>

        <manvolnum>1</manvolnum>
      </citerefentry></para>
  </refsect1>
</refentry>
